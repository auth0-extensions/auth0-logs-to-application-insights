module.exports=function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="/build/",t(t.s=25)}([function(e,t){e.exports=require("boom")},function(e,t){e.exports=require("request")},function(e,t,n){"use strict";e.exports=function(e,t,n){var r={clientId:e.clientId(t,n),domain:e.domain(t,n),clientSecret:e.clientSecret(t,n),secretEncoding:e.secretEncoding(t,n)};return 4===!!r.clientId+!!r.domain+!!r.clientSecret+!!r.secretEncoding?r:null}},function(e,t){function n(e){throw new Error("Cannot find module '"+e+"'.")}n.keys=function(){return[]},n.resolve=n,e.exports=n,n.id=3},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,n){"use strict";function r(e,t){this._id=e,this._clearFn=t}var o=Function.prototype.apply;t.setTimeout=function(){return new r(o.call(setTimeout,window,arguments),clearTimeout)},t.setInterval=function(){return new r(o.call(setInterval,window,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},r.prototype.unref=r.prototype.ref=function(){},r.prototype.close=function(){this._clearFn.call(window,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout(function(){e._onTimeout&&e._onTimeout()},t))},n(14),t.setImmediate=setImmediate,t.clearImmediate=clearImmediate},function(e,t,n){"use strict";function r(e,t,n){t(null,function(t,r,o){o.writeHead(200,{"Content-Type":"text/html"});var i=n(e.script);o.end(i)})}function o(e){return e.auth0=function(n){return t.auth0(e,n)},e}function i(e){return o(function(t,n,r){var o=c(n.x_wt);return n.originalUrl=n.url,n.url=n.url.replace(o,"/"),n.webtaskContext=u(t),e(n,r)})}function a(e){var t;return e.ext("onRequest",function(e,n){var r=c(e.x_wt.jtn);e.setUrl(e.url.replace(r,"/")),e.webtaskContext=t}),o(function(n,r,o){var i=e._dispatch();t=u(n),i(r,o)})}function s(e){return o(function(t,n,r){var o=c(n.x_wt);return n.originalUrl=n.url,n.url=n.url.replace(o,"/"),n.webtaskContext=u(t),e.emit("request",n,r)})}function c(e){var t=e.container.replace(l,"\\$&"),n=e.jtn?e.jtn.replace(l,"\\$&"):"";if(e.url_format===p)return new RegExp("^/api/run/"+t+"/(?:"+n+"/?)?");if(e.url_format===f)return new RegExp("^/"+t+"/(?:"+n+"/?)?");if(e.url_format===d)return new RegExp("^/(?:"+n+"/?)?");throw new Error("Unsupported webtask URL format.")}function u(e){function t(e,t,r){var o=n(0);"function"==typeof t&&(r=t,t={}),r(o.preconditionFailed("Storage is not available in this context"))}function r(t,r,o){var i=n(0),a=n(1);"function"==typeof r&&(o=r,r={}),a({uri:e.secrets.EXT_STORAGE_URL,method:"GET",headers:r.headers||{},qs:{path:t},json:!0},function(e,t,n){return e?o(i.wrap(e,502)):404===t.statusCode&&Object.hasOwnProperty.call(r,"defaultValue")?o(null,r.defaultValue):t.statusCode>=400?o(i.create(t.statusCode,n&&n.message)):void o(null,n)})}function o(e,t,r,o){var i=n(0);"function"==typeof r&&(o=r,r={}),o(i.preconditionFailed("Storage is not available in this context"))}function i(t,r,o,i){var a=n(0),s=n(1);"function"==typeof o&&(i=o,o={}),s({uri:e.secrets.EXT_STORAGE_URL,method:"PUT",headers:o.headers||{},qs:{path:t},body:r},function(e,t,n){return e?i(a.wrap(e,502)):t.statusCode>=400?i(a.create(t.statusCode,n&&n.message)):void i(null)})}return e.read=e.secrets.EXT_STORAGE_URL?r:t,e.write=e.secrets.EXT_STORAGE_URL?i:o,e}t.auth0=n(16),t.fromConnect=t.fromExpress=i,t.fromHapi=a,t.fromServer=t.fromRestify=s,t.express=function(e,t){e.nodejsCompiler(e.script,function(e,n){if(e)return t(e);try{n=i(n)}catch(e){return t(e)}return t(null,n)})},t.html=function(e,t){r(e,t,function(e){return e})},t.pug=function(e,t){var o=n(22);r(e,t,function(e){return o.render(e)})},t.jade=t.pug,t.cs=function(e,t){t(null,n(12).func(e.script))};var l=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,d=3,f=2,p=1},function(e,t){e.exports=require("applicationinsights")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("lru-memoizer")},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("useragent")},function(e,t,n){"use strict";function r(){for(var e in l)if(process.versions.node.match(l[e][0]))return l[e][1];throw new Error("The edge module has not been pre-compiled for node.js version "+process.version+". You must build a custom version of edge.node. Please refer to https://github.com/tjanczuk/edge for building instructions.")}var o,i,a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=n(20),c=n(21),u=c.resolve(__dirname,"../build/Release/"+(process.env.EDGE_USE_CORECLR||!s.existsSync(c.resolve(__dirname,"../build/Release/edge_nativeclr.node"))?"edge_coreclr.node":"edge_nativeclr.node")),l=[[/^0\.8\./,"0.8.22"],[/^0\.10\./,"0.10.0"],[/^0\.12\./,"0.12.0"],[/^4\./,"4.1.1"],[/^5\./,"5.1.0"],[/^6\./,"6.4.0"]];if(process.env.EDGE_NATIVE)i=process.env.EDGE_NATIVE;else if(s.existsSync(u))i=u;else{if("win32"!==process.platform)throw new Error("The edge native module is not available at "+u+". You can use EDGE_NATIVE environment variable to provide alternate location of edge.node. If you need to build edge.node, follow build instructions for your platform at https://github.com/tjanczuk/edge");i=c.resolve(__dirname,"./native/"+process.platform+"/"+process.arch+"/"+r()+"/"+(process.env.EDGE_USE_CORECLR?"edge_coreclr":"edge_nativeclr"))}process.env.EDGE_DEBUG&&console.log("Load edge native library from: "+i),i.match(/edge_coreclr\.node$/i)&&(process.env.EDGE_USE_CORECLR=1),process.env.EDGE_USE_CORECLR&&!process.env.EDGE_BOOTSTRAP_DIR&&s.existsSync(c.join(__dirname,"bootstrap","bin","Release","netcoreapp1.0","bootstrap.dll"))&&(process.env.EDGE_BOOTSTRAP_DIR=c.join(__dirname,"bootstrap","bin","Release","netcoreapp1.0")),process.env.EDGE_NATIVE=i,o=!function(){var e=new Error('Cannot find module "."');throw e.code="MODULE_NOT_FOUND",e}(),t.func=function(e,t){if(t||(t=e,e="cs"),"string"==typeof t)t=t.match(/\.dll$/i)?{assemblyFile:t}:{source:t};else if("function"==typeof t){var n,r=Error.prepareStackTrace;try{Error.prepareStackTrace=function(e,t){return t},n=(new Error).stack}finally{Error.prepareStackTrace=r}t={source:t,jsFileName:n[1].getFileName(),jsLineNumber:n[1].getLineNumber()}}else if("object"!==(void 0===t?"undefined":a(t)))throw new Error("Specify the source code as string or provide an options object.");if("string"!=typeof e)throw new Error("The first argument must be a string identifying the language compiler to use.");if(!t.assemblyFile){var i,s="edge-"+e.toLowerCase();try{i=!function(){var e=new Error('Cannot find module "."');throw e.code="MODULE_NOT_FOUND",e}()}catch(t){throw new Error("Unsupported language '"+e+"'. To compile script in language '"+e+"' an npm module '"+s+"' must be installed.")}try{t.compiler=i.getCompiler()}catch(t){throw new Error("The '"+s+"' module required to compile the '"+e+"' language does not contain getCompiler() function.")}if("string"!=typeof t.compiler)throw new Error("The '"+s+"' module required to compile the '"+e+"' language did not specify correct compiler package name or assembly.");process.env.EDGE_USE_CORECLR&&(t.bootstrapDependencyManifest=i.getBootstrapDependencyManifest())}if(!t.assemblyFile&&!t.source)throw new Error("Provide DLL or source file name or .NET script literal as a string parmeter, or specify an options object with assemblyFile or source string property.");if(t.assemblyFile&&t.source)throw new Error("Provide either an asseblyFile or source property, but not both.");if("function"==typeof t.source){var c=t.source.toString().match(/[^]*\/\*([^]*)\*\/\s*\}$/);if(!c)throw new Error("If .NET source is provided as JavaScript function, function body must be a /* ... */ comment.");t.source=c[1]}if(void 0!==t.references){if(!Array.isArray(t.references))throw new Error("The references property must be an array of strings.");t.references.forEach(function(e){if("string"!=typeof e)throw new Error("The references property must be an array of strings.")})}if(t.assemblyFile){if(!t.typeName){var u=t.assemblyFile.match(/([^\\\/]+)\.dll$/i);if(!u)throw new Error("Unable to determine the namespace name based on assembly file name. Specify typeName parameter as a namespace qualified CLR type name of the application class.");t.typeName=u[1]+".Startup"}}else t.typeName||(t.typeName="Startup");return t.methodName||(t.methodName="Invoke"),o.initializeClrFunc(t)}},function(e,t,n){"use strict";e.exports=n(19)},function(e,t,n){"use strict";!function(e,t){function n(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),n=0;n<t.length;n++)t[n]=arguments[n+1];var r={callback:e,args:t};return m[p]=r,f(p),p++}function r(e){delete m[e]}function o(e){var n=e.callback,r=e.args;switch(r.length){case 0:n();break;case 1:n(r[0]);break;case 2:n(r[0],r[1]);break;case 3:n(r[0],r[1],r[2]);break;default:n.apply(t,r)}}function i(e){if(h)setTimeout(i,0,e);else{var t=m[e];if(t){h=!0;try{o(t)}finally{r(e),h=!1}}}}function a(){f=function(e){process.nextTick(function(){i(e)})}}function s(){if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}function c(){var t="setImmediate$"+Math.random()+"$",n=function(n){n.source===e&&"string"==typeof n.data&&0===n.data.indexOf(t)&&i(+n.data.slice(t.length))};e.addEventListener?e.addEventListener("message",n,!1):e.attachEvent("onmessage",n),f=function(n){e.postMessage(t+n,"*")}}function u(){var e=new MessageChannel;e.port1.onmessage=function(e){i(e.data)},f=function(t){e.port2.postMessage(t)}}function l(){var e=g.documentElement;f=function(t){var n=g.createElement("script");n.onreadystatechange=function(){i(t),n.onreadystatechange=null,e.removeChild(n),n=null},e.appendChild(n)}}function d(){f=function(e){setTimeout(i,0,e)}}if(!e.setImmediate){var f,p=1,m={},h=!1,g=e.document,v=Object.getPrototypeOf&&Object.getPrototypeOf(e);v=v&&v.setTimeout?v:e,"[object process]"==={}.toString.call(e.process)?a():s()?c():e.MessageChannel?u():g&&"onreadystatechange"in g.createElement("script")?l():d(),v.setImmediate=n,v.clearImmediate=r}}("undefined"==typeof self?"undefined"==typeof global?void 0:global:self)},function(e,t,n){"use strict";e.exports=function(e,t,n,r,o,i){function a(){var e=t.getAccessToken(n,r);if(!e)return t.loginError({code:401,message:"Unauthorized.",error:"Missing access token.",redirect:i.baseUrl+"/login"},n,r,o,i.baseUrl);t.validateToken(n,r,e,function(a,c){if(a)return t.loginError({code:a.code||401,message:a.message||"Unauthorized."},n,r,o,i.baseUrl);n.accessToken=e,n.user=r.user=c,s()})}function s(){return t.authorized&&!t.authorized(n,r)?t.loginError({code:403,message:"Forbidden."},n,r,o,i.baseUrl):c()}function c(){return e(n,r,o)}return t.exclude&&t.exclude(n,r,i.appPath)?c():a()}},function(e,t,n){"use strict";function r(e,t){return function(n,r,i){if(!r.x_wt.jtn||!r.x_wt.container)return a({code:400,message:"Auth0 authentication can only be used with named webtasks."},i);var s=o(r);if(!s)return a({code:400,message:"Error processing request URL path."},i);switch("GET"===r.method&&s.appPath){case"/login":d(t,n,r,i,s);break;case"/callback":f(t,n,r,i,s);break;default:l(e,t,n,r,i,s)}}}function o(e){var t=c.parse(e.url,!0),n=t.pathname.split("/");if("api"===n[1]&&"run"===n[2]&&n[3]===e.x_wt.container&&n[4]===e.x_wt.jtn)t.basePath=n.splice(0,5).join("/");else if(n[1]===e.x_wt.container&&n[2]===e.x_wt.jtn)t.basePath=n.splice(0,3).join("/");else{if(n[1]!==e.x_wt.jtn||0!==e.headers.host.indexOf(e.x_wt.container+"."))return null;t.basePath=n.splice(0,2).join("/")}return t.appPath="/"+n.join("/"),t.baseUrl=[e.headers["x-forwarded-proto"]||"https","://",e.headers.host,t.basePath].join(""),t}function i(e){return'\n    <!DOCTYPE html5>\n    <html>\n    <head>\n        <meta charset="utf-8"/>\n        <meta http-equiv="X-UA-Compatible" content="IE=edge"/>\n        <meta name="viewport" content="width=device-width, initial-scale=1"/>\n        <link href="https://cdn.auth0.com/styleguide/latest/index.css" rel="stylesheet" />\n        <title>Access denied</title>\n    </head>\n    <body>\n        <div class="container">\n        <div class="row text-center">\n            <h1><a href="https://auth0.com" title="Go to Auth0!"><img src="https://cdn.auth0.com/styleguide/1.0.0/img/badge.svg" alt="Auth0 badge" /></a></h1>\n            <h1>Not authorized</h1>\n            <p><a href="'+e+'">Try again</a></p>\n        </div>\n        </div>\n    </body>\n    </html>'}function a(e,t){t.writeHead(e.code||500,{"Content-Type":"application/json","Cache-Control":"no-cache"}),t.end(JSON.stringify(e))}var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c=n(24),u=n(13).Buffer,l=n(15),d=n(18),f=n(17),p=n(2);e.exports=function(e,t){if("function"!=typeof e||3!==e.length)throw new Error("The auth0() function can only be called on webtask functions with the (ctx, req, res) signature.");if(t||(t={}),"object"!==(void 0===t?"undefined":s(t)))throw new Error("The options parameter must be an object.");if(t.scope&&"string"!=typeof t.scope)throw new Error("The scope option, if specified, must be a string.");if(t.authorized&&["string","function"].indexOf(s(t.authorized))<0&&!Array.isArray(t.authorized))throw new Error("The authorized option, if specified, must be a string or array of strings with e-mail or domain names, or a function that accepts (ctx, req) and returns boolean.");if(t.exclude&&["string","function"].indexOf(s(t.exclude))<0&&!Array.isArray(t.exclude))throw new Error("The exclude option, if specified, must be a string or array of strings with URL paths that do not require authentication, or a function that accepts (ctx, req, appPath) and returns boolean.");if(t.clientId&&"function"!=typeof t.clientId)throw new Error("The clientId option, if specified, must be a function that accepts (ctx, req) and returns an Auth0 Client ID.");if(t.clientSecret&&"function"!=typeof t.clientSecret)throw new Error("The clientSecret option, if specified, must be a function that accepts (ctx, req) and returns an Auth0 Client Secret.");if(t.secretEncoding&&"function"!=typeof t.secretEncoding)throw new Error('The secretEncoding option, if specified, must be a function that accepts (ctx, req) and returns a character encoding name for use with the "Buffer" class.');if(t.domain&&"function"!=typeof t.domain)throw new Error("The domain option, if specified, must be a function that accepts (ctx, req) and returns an Auth0 Domain.");if(t.createToken&&"function"!=typeof t.createToken)throw new Error("The createToken option, if specified, must be a function that accepts (ctx, res, idToken, accessToken) and returns an access token that can be used to authenticate future calls to webtask APIs.");if(t.getAccessToken&&"function"!=typeof t.getAccessToken)throw new Error("The getAccessToken option, if specified, must be a function that accepts (ctx, req) and returns the access token associated with the request, or null.");if(t.validateToken&&"function"!=typeof t.validateToken)throw new Error("The validateToken option, if specified, must be a function that accepts (ctx, req, token, cb) and calls the callback with (error, userProfile).");if(t.loginSuccess&&"function"!=typeof t.loginSuccess)throw new Error("The loginSuccess option, if specified, must be a function that accepts (ctx, req, res, baseUrl) and generates a response.");if(t.loginError&&"function"!=typeof t.loginError)throw new Error("The loginError option, if specified, must be a function that accepts (error, ctx, req, res, baseUrl) and generates a response.");if(t.clientId=t.clientId||function(e,t){return e.secrets.AUTH0_CLIENT_ID},t.clientSecret=t.clientSecret||function(e,t){return e.secrets.AUTH0_CLIENT_SECRET},t.secretEncoding=t.secretEncoding||function(e,t){return void 0===e.secrets.AUTH0_SECRET_ENCODING?"base64":e.secrets.AUTH0_SECRET_ENCODING},t.domain=t.domain||function(e,t){return e.secrets.AUTH0_DOMAIN},t.createToken=t.createToken||function(e,t,n,r){return n},t.getAccessToken=t.getAccessToken||function(e,t){return t.headers.authorization&&"Bearer"===t.headers.authorization.split(" ")[0]?t.headers.authorization.split(" ")[1]:t.query&&t.query.access_token},t.validateToken=t.validateToken||function(e,r,o,i){var a=p(t,e,r);if(!a)return i({code:400,message:"Auth0 Client ID, Client Secret, and Auth0 Domain must be specified."});var s=void 0;try{s=n(4).verify(o,u.from(a.clientSecret,a.secretEncoding),{audience:a.clientId,issuer:"https://"+a.domain+"/"})}catch(e){return i({code:401,message:"Unauthorized: "+e.message})}return i(null,s)},t.loginSuccess=t.loginSuccess||function(e,t,n,r){return n.writeHead(302,{Location:r+"?access_token="+e.accessToken}),n.end()},t.loginError=t.loginError||function(e,t,n,r,o){return"GET"===n.method?e.redirect?(r.writeHead(302,{Location:e.redirect,"x-wt-error":e.message}),r.end(JSON.stringify(e))):400===e.code?a(e,r):(r.writeHead(e.code||401,{"Content-Type":"text/html","Cache-Control":"no-cache","x-wt-error":e.message}),r.end(i(o+"/login"))):a(e,r)},"string"==typeof t.authorized&&(t.authorized=[t.authorized]),Array.isArray(t.authorized)){var o=[];t.authorized.forEach(function(e){o.push(e.toLowerCase())}),t.authorized=function(e,t){if(e.user.email_verified)for(var n=0;n<o.length;n++){var r=e.user.email.toLowerCase();if(r===o[n]||"@"===o[n][0]&&r.indexOf(o[n])>1)return!0}return!1}}if("string"==typeof t.exclude&&(t.exclude=[t.exclude]),Array.isArray(t.exclude)){var c=t.exclude;t.exclude=function(e,t,n){return c.indexOf(n)>-1}}return r(e,t)}},function(e,t,n){"use strict";var r=n(2);e.exports=function(e,t,o,i,a){function s(r,s){var c=n(4);try{o.user=t.user=c.decode(r)}catch(n){return e.loginError({code:502,message:"Cannot parse id_token returned from Auth0.",id_token:r,error:n.message},t,o,i,a.baseUrl)}return t.accessToken=e.createToken(t,o,r,s),"string"!=typeof t.accessToken?e.loginError({code:400,message:"The createToken function did not return a string access token."},t,o,i,a.baseUrl):e.loginSuccess(t,o,i,a.baseUrl)}if(!t.query.code)return e.loginError({code:401,message:"Authentication error.",callbackQuery:t.query},t,o,i,a.baseUrl);var c=r(e,t,o);return c?n(23).post("https://"+c.domain+"/oauth/token").type("form").send({client_id:c.clientId,client_secret:c.clientSecret,redirect_uri:a.baseUrl+"/callback",code:t.query.code,grant_type:"authorization_code"}).timeout(15e3).end(function(n,r){return n||!r.ok?e.loginError({code:502,message:"OAuth code exchange completed with error.",error:n&&n.message,auth0Status:r&&r.status,auth0Response:r&&(r.body||r.text)},t,o,i,a.baseUrl):s(r.body.id_token,r.body.access_token)}):e.loginError({code:400,message:"Auth0 Client ID, Client Secret, and Auth0 Domain must be specified."},t,i,i,a.baseUrl)}},function(e,t,n){"use strict";var r=n(2);e.exports=function(e,t,n,o,i){var a=r(e,t,n),s="openid name email email_verified "+(e.scope||"");if(a){var c="https://"+a.domain+"/authorize?response_type=code&scope="+encodeURIComponent(s)+"&client_id="+encodeURIComponent(a.clientId)+"&redirect_uri="+encodeURIComponent(i.baseUrl+"/callback");return o.writeHead(302,{Location:c}),o.end()}return e.loginError({code:400,message:"You must specify Auth0 client ID, client secret, and domain when creating the webtask. See https://webtask.io/docs/auth for details."},t,n,o,i.baseUrl)}},function(e,t){e.exports=require("buffer")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("pug")},function(e,t){e.exports=require("superagent")},function(e,t){e.exports=require("url")},function(e,t,n){"use strict";(function(t){"use latest";function r(e,n){var r=e.webtaskContext;return r.data.AUTH0_DOMAIN&&r.data.AUTH0_CLIENT_ID&&r.data.AUTH0_CLIENT_SECRET?r.data.APPINSIGHTS_INSTRUMENTATIONKEY?void e.webtaskContext.storage.get(function(s,c){var u=void 0===c?null:c.checkpointId;console.log("Starting from:",u);var l=f(r.data.APPINSIGHTS_INSTRUMENTATIONKEY);l.config.endpointUrl="https://dc.services.visualstudio.com/v2/track",l.commonProperties={auth0_domain:r.data.AUTH0_DOMAIN};var d=function(e){return e()},m=[],h=function n(i,s){var c=Number.parseInt(r.data.BATCH_SIZE);c=c>100?100:c,o(e.webtaskContext.data.AUTH0_DOMAIN,e.access_token,c,i,function(e,r){return e.error?(console.log("Error getting logs from Auth0",e.message),s(r)):e&&e.length>0?(e.forEach(function(e){e.date&&a().diff(a(e.date),"hours")<48&&m.push(e)}),console.log("Retrieved "+m.length+" logs from Auth0 after "+i+"."),t(function(){u=e[e.length-1]._id,n(e[e.length-1]._id,s)}),void 0):(console.log("Reached end of logs. Total: "+m.length+"."),s(null,m))})},g=function(e,t){if(console.log("Exporting logs to Application Insights: "+e.length),e.forEach(function(e){var t=0;e.type_code=e.type,p[e.type]&&(t=p[e.type].level,e.type=p[e.type].event),e.ip&&""!==e.ip||delete e.ip,e.user_id&&""!==e.user_id||delete e.user_id,e.user_name&&""!==e.user_name||delete e.user_name,e.connection&&""!==e.connection||delete e.connection,e.client_name&&""!==e.client_name||delete e.client_name,e.description&&""!==e.description||delete e.description,e.isMobile=e.isMobile&&"yes"||"no",e.details&&(e.details=JSON.stringify(e.details,null,2)),e.details&&e.details.length>8185&&(e.details=e.details.substring(0,8185)+"...");var n=i.parse(e.user_agent);if(e.os=n.os.toString(),e.os_version=n.os.toVersion(),e.device=n.device.toString(),e.device_version=n.device.toVersion(),e.device&&e.device.indexOf("Generic Smartphone")>=0&&(e.device=n.os.toString(),e.device_version=n.os.toVersion()),t>=4){var r=new Error(e.type);r.name=e.type,l.trackException(r,e)}l.trackEvent(e.type,e)}),!e||!e.length)return console.log("No data to flush..."),t(null,'{ "itemsAccepted": 0 }');console.log("Flushing all data..."),l.sendPendingData(function(e){return t(null,e)})};d(function(t){if(t)return n.status(500).send({err:t});h(u,function(t,r){if(!r)return n.status(500).send({err:t});g(r,function(t,r){try{r=JSON.parse(r)}catch(t){return console.log("Error parsing response, this might indicate that an error occurred:",r),e.webtaskContext.storage.set({checkpointId:u},{force:1},function(e){if(e)return n.status(500).send(e);n.status(500).send({error:r})})}return r.errors.length>0?n.status(500).send(r.errors):r.itemsAccepted&&r.itemsAccepted>0?e.webtaskContext.storage.set({checkpointId:u},{force:1},function(e){if(e)return console.log("Error storing startCheckpoint",e),n.status(500).send({error:e});n.sendStatus(200)}):(console.log("No items accepted."),e.webtaskContext.storage.set({checkpointId:u},{force:1},function(e){if(e)return console.log("Error storing checkpoint",e),n.status(500).send({error:e});n.sendStatus(200)}))})})})}):n.status(400).send({message:"Application Insights instrumentation key is missing."}):n.status(400).send({message:"Auth0 API v2 credentials or domain missing."})}function o(e,t,n,r,o){l({method:"GET",url:"https://"+e+"/api/v2/logs",json:!0,qs:{take:n,from:r,sort:"date:1",per_page:n},headers:{Authorization:"Bearer "+t,Accept:"application/json"}},function(e,t,n){e?(console.log("Error getting logs",e),o(null,e)):o(n)})}var i=n(11),a=n(10),s=n(8),c=n(6),u=s(),l=n(1),d=n(9),f=function(e){var t=n(7),r=t.getClient(e),o=r.getEnvelope;return r.getEnvelope=function(e,t){var n=o.apply(r,[e,t]);return n.time=e.baseData.properties.date,n.os=e.baseData.properties.os,n.osVer=e.baseData.properties.os_version,n.tags["ai.device.id"]=e.baseData.properties.device,n.tags["ai.device.machineName"]=e.baseData.properties.client_name,n.tags["ai.device.type"]="mobile:"+e.baseData.properties.isMobile,n.tags["ai.device.os"]=e.baseData.properties.os,n.tags["ai.device.osVersion"]=e.baseData.properties.os_version,n.tags["ai.device.osArchitecture"]="",n.tags["ai.device.osPlatform"]=e.baseData.properties.os,e.baseData.properties.ip&&(n.tags["ai.location.ip"]=e.baseData.properties.ip),(e.baseData.properties.user_id||e.baseData.properties.user_name)&&(n.tags["ai.user.id"]=e.baseData.properties.user_id||e.baseData.properties.user_name,n.tags["ai.user.accountId"]=e.baseData.properties.user_name||e.baseData.properties.user_id,n.tags["ai.user.authUserId"]=e.baseData.properties.user_name||e.baseData.properties.user_id),e.baseData.properties.user_agent&&(n.tags["ai.user.agent"]=e.baseData.properties.user_agent),n},r},p={s:{event:"Success Login",level:1},seacft:{event:"Success Exchange",level:1},seccft:{event:"Success Exchange (Client Credentials)",level:1},feacft:{event:"Failed Exchange",level:3},feccft:{event:"Failed Exchange (Client Credentials)",level:3},f:{event:"Failed Login",level:3},w:{event:"Warnings During Login",level:2},du:{event:"Deleted User",level:1},fu:{event:"Failed Login (invalid email/username)",level:3},fp:{event:"Failed Login (wrong password)",level:3},fc:{event:"Failed by Connector",level:3},fco:{event:"Failed by CORS",level:3},con:{event:"Connector Online",level:1},coff:{event:"Connector Offline",level:3},fcpro:{event:"Failed Connector Provisioning",level:4},ss:{event:"Success Signup",level:1},fs:{event:"Failed Signup",level:3},cs:{event:"Code Sent",level:0},cls:{event:"Code/Link Sent",level:0},sv:{event:"Success Verification Email",level:0},fv:{event:"Failed Verification Email",level:0},scp:{event:"Success Change Password",level:1},fcp:{event:"Failed Change Password",level:3},sce:{event:"Success Change Email",level:1},fce:{event:"Failed Change Email",level:3},scu:{event:"Success Change Username",level:1},fcu:{event:"Failed Change Username",level:3},scpn:{event:"Success Change Phone Number",level:1},fcpn:{event:"Failed Change Phone Number",level:3},svr:{event:"Success Verification Email Request",level:0},fvr:{event:"Failed Verification Email Request",level:3},scpr:{event:"Success Change Password Request",level:0},fcpr:{event:"Failed Change Password Request",level:3},fn:{event:"Failed Sending Notification",level:3},sapi:{event:"API Operation"},limit_ui:{event:"Too Many Calls to /userinfo",level:4},api_limit:{event:"Rate Limit On API",level:4},sdu:{event:"Successful User Deletion",level:1},fdu:{event:"Failed User Deletion",level:3},fapi:{event:"Failed API Operation",level:3},limit_wc:{event:"Blocked Account",level:3},limit_mu:{event:"Blocked IP Address",level:3},slo:{event:"Success Logout",level:1},flo:{event:" Failed Logout",level:3},sd:{event:"Success Delegation",level:1},fd:{event:"Failed Delegation",level:3}},m=d({load:function(e,t,n,r,o){l({method:"POST",url:e,json:!0,body:{audience:t,grant_type:"client_credentials",client_id:n,client_secret:r}},function(e,t,n){n.error_description?o(null,n.error_description):o(n.access_token)})},hash:function(e){return e},max:100,maxAge:36e5});u.use(function(e,t,n){m("https://"+e.webtaskContext.data.AUTH0_DOMAIN+"/oauth/token","https://"+e.webtaskContext.data.AUTH0_DOMAIN+"/api/v2/",e.webtaskContext.data.AUTH0_CLIENT_ID,e.webtaskContext.data.AUTH0_CLIENT_SECRET,function(t,r){if(r)return console.log("Error getting access_token",r),n(r);e.access_token=t,n()})}),u.get("/",r),u.post("/",r),e.exports=c.fromExpress(u)}).call(t,n(5).setImmediate)}]);